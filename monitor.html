<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monitor</title>
    <style>
      :root {
        --bg: #0f0f12;
        --panel: #17171c;
        --panel-border: #2a2a33;
        --text: #e9e9f0;
        --muted: #a7a7b3;
        --accent: #ffb84d;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Mono", "Fira Code", "Cascadia Mono", "Source Code Pro", Menlo,
          Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: radial-gradient(circle at top, #1a1a21 0%, #0f0f12 60%);
        color: var(--text);
        min-height: 100vh;
      }

      body::after {
        content: "";
        position: fixed;
        left: 0;
        right: 0;
        top: -4px;
        height: 4px;
        pointer-events: none;
        background: rgba(0, 255, 140, 0.6);
        box-shadow: 0 0 16px rgba(0, 255, 140, 0.55);
        mix-blend-mode: screen;
        opacity: 0.85;
        transform-origin: top center;
        animation: scanline 11s infinite;
        animation-timing-function: cubic-bezier(0.15, 0.8, 0.2, 1);
      }

      @keyframes scanline {
        0% {
          transform: translateY(-12px) scaleY(1);
          opacity: 0.35;
        }
        8% {
          transform: translateY(70vh) scaleY(0.7);
          opacity: 0.85;
        }
        16% {
          transform: translateY(100vh) scaleY(0.35);
          opacity: 0.25;
        }
        18.18% {
          transform: translateY(110vh) scaleY(0);
          opacity: 0;
        }
        18.19% {
          transform: translateY(-12px) scaleY(1);
          opacity: 0.35;
        }
        26.18% {
          transform: translateY(70vh) scaleY(0.7);
          opacity: 0.85;
        }
        34.18% {
          transform: translateY(100vh) scaleY(0.35);
          opacity: 0.25;
        }
        36.36% {
          transform: translateY(110vh) scaleY(0);
          opacity: 0;
        }
        36.37% {
          transform: translateY(-12px) scaleY(1);
          opacity: 0.35;
        }
        44.36% {
          transform: translateY(70vh) scaleY(0.7);
          opacity: 0.85;
        }
        52.36% {
          transform: translateY(100vh) scaleY(0.35);
          opacity: 0.25;
        }
        54.54% {
          transform: translateY(110vh) scaleY(0);
          opacity: 0;
        }
        54.55% {
          transform: translateY(-12px) scaleY(1);
          opacity: 0;
        }
        100% {
          transform: translateY(-12px) scaleY(1);
          opacity: 0;
        }
      }

      header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--panel-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      header h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      header .meta {
        color: var(--muted);
        font-size: 12px;
      }

      .current-step-bar {
        margin: 0 16px 6px;
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid rgba(0, 255, 140, 0.35);
        background: linear-gradient(90deg, rgba(0, 255, 140, 0.12), rgba(0, 255, 140, 0.02));
        color: #b8ffe1;
        text-shadow: 0 0 10px rgba(0, 255, 140, 0.65);
        box-shadow: 0 0 18px rgba(0, 255, 140, 0.35);
        font-size: 26px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .current-step-bar span {
        color: #e9fff6;
        text-transform: none;
        letter-spacing: 0;
        font-weight: 600;
        font-size: 26px;
      }

      main {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        padding: 16px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 70vh;
        box-shadow: 0 0 0 1px rgba(0, 255, 140, 0.06), 0 0 22px rgba(0, 255, 140, 0.12),
          inset 0 0 18px rgba(0, 255, 140, 0.08);
        position: relative;
      }

      .panel::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 12px;
        background: radial-gradient(circle at 20% 10%, rgba(0, 255, 140, 0.12), transparent 45%),
          radial-gradient(circle at 80% 90%, rgba(0, 160, 255, 0.08), transparent 50%);
        opacity: 0.55;
        mix-blend-mode: screen;
        pointer-events: none;
        animation: panelGlow 6s ease-in-out infinite;
      }

      @keyframes panelGlow {
        0% {
          opacity: 0.35;
          filter: blur(0px);
        }
        50% {
          opacity: 0.7;
          filter: blur(2px);
        }
        100% {
          opacity: 0.35;
          filter: blur(0px);
        }
      }

      .panel header {
        border-bottom: 1px solid var(--panel-border);
        padding: 10px 14px;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: #1f1f26;
        text-shadow: 0 0 12px rgba(0, 255, 140, 0.35);
        position: relative;
        z-index: 1;
      }

      .panel pre {
        margin: 0;
        padding: 14px;
        white-space: pre-wrap;
        word-break: break-word;
        overflow: auto;
        flex: 1;
        font-size: 12px;
        line-height: 1.5;
      }

      .panel .markdown {
        margin: 0;
        padding: 14px;
        overflow: auto;
        flex: 1;
        font-size: 13px;
        line-height: 1.6;
        font-family: "IBM Plex Mono", "Fira Code", "Cascadia Mono", "Source Code Pro", Menlo,
          Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        color: var(--text);
        text-shadow: 0 0 10px rgba(0, 255, 140, 0.2);
        position: relative;
        z-index: 1;
      }

      .markdown h1,
      .markdown h2,
      .markdown h3 {
        margin: 0 0 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .markdown p {
        margin: 0 0 10px;
      }

      .markdown ul {
        margin: 0 0 10px 18px;
        padding: 0;
      }

      .markdown li {
        margin: 0 0 6px;
      }

      .markdown code {
        font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        background: #1c1c24;
        border: 1px solid var(--panel-border);
        padding: 1px 5px;
        border-radius: 6px;
        font-size: 12px;
      }

      .markdown pre {
        background: #1c1c24;
        border: 1px solid var(--panel-border);
        padding: 12px;
        border-radius: 8px;
        overflow: auto;
      }

      .status {
        color: var(--accent);
      }

      .error {
        color: #ff7b7b;
      }

      .muted {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Monitor</h1>
      <div class="meta">
        Refresh interval: <span class="status" id="refresh-interval">10s</span> · Last update:
        <span id="last-updated" class="muted">—</span>
      </div>
    </header>
    <div class="current-step-bar">
      Current step: <span id="current-step">Loading…</span>
    </div>
    <main>
      <section class="panel">
        <header>PLAN.md</header>
        <div id="plan" class="markdown">Loading…</div>
      </section>
      <section class="panel">
        <header>LOG.md</header>
        <div id="log" class="markdown">Loading…</div>
      </section>
      <section class="panel">
        <header>RELEASES.md</header>
        <div id="releases" class="markdown">Loading…</div>
      </section>
    </main>
    <script>
      const REFRESH_MS = 3000;
      const planEl = document.getElementById("plan");
      const logEl = document.getElementById("log");
      const releasesEl = document.getElementById("releases");
      const lastUpdatedEl = document.getElementById("last-updated");
      const refreshIntervalEl = document.getElementById("refresh-interval");
      const currentStepEl = document.getElementById("current-step");

      refreshIntervalEl.textContent = `${REFRESH_MS / 1000}s`;

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function renderMarkdown(md) {
        const blocks = md.split(/```/g);
        const htmlParts = [];

        blocks.forEach((block, index) => {
          if (index % 2 === 1) {
            htmlParts.push(
              `<pre><code>${escapeHtml(block.replace(/^\n+|\n+$/g, ""))}</code></pre>`
            );
            return;
          }

          const lines = block.split("\n");
          let inList = false;

          lines.forEach((line) => {
            const trimmed = line.trim();

            if (!trimmed) {
              if (inList) {
                htmlParts.push("</ul>");
                inList = false;
              }
              return;
            }

            const headerMatch = trimmed.match(/^(#{1,3})\s+(.*)$/);
            if (headerMatch) {
              if (inList) {
                htmlParts.push("</ul>");
                inList = false;
              }
              const level = headerMatch[1].length;
              htmlParts.push(`<h${level}>${escapeHtml(headerMatch[2])}</h${level}>`);
              return;
            }

            const listMatch = trimmed.match(/^-\s+(.*)$/);
            if (listMatch) {
              if (!inList) {
                htmlParts.push("<ul>");
                inList = true;
              }
              htmlParts.push(`<li>${escapeInline(listMatch[1])}</li>`);
              return;
            }

            if (inList) {
              htmlParts.push("</ul>");
              inList = false;
            }

            htmlParts.push(`<p>${escapeInline(trimmed)}</p>`);
          });

          if (inList) {
            htmlParts.push("</ul>");
          }
        });

        return htmlParts.join("");
      }

      function escapeInline(text) {
        let output = escapeHtml(text);
        output = output.replace(/`([^`]+)`/g, "<code>$1</code>");
        output = output.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        output = output.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        return output;
      }

      async function loadFile(path, targetEl, options = {}) {
        const { lineLimit, cacheBuster } = options;
        try {
          const url = cacheBuster ? `${path}?t=${cacheBuster}` : path;
          const response = await fetch(url, { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          let text = await response.text();
          if (Number.isFinite(lineLimit)) {
            const lines = text.split("\n");
            text = lines.slice(-lineLimit).join("\n");
          }
          targetEl.innerHTML = renderMarkdown(text);
          targetEl.classList.remove("error");
          return text;
        } catch (error) {
          targetEl.textContent = `Failed to load ${path}: ${error.message}`;
          targetEl.classList.add("error");
          return null;
        }
      }

      function extractCurrentStep(planText) {
        if (!planText) return "Unavailable";
        const lines = planText.split("\n");
        let inCurrent = false;
        for (const line of lines) {
          if (line.trim() === "## Current step") {
            inCurrent = true;
            continue;
          }
          if (inCurrent && line.trim().startsWith("- ")) {
            return line.replace(/^-\\s*/, "");
          }
          if (inCurrent && line.startsWith("## ")) {
            break;
          }
        }
        return "Not found";
      }

      async function refresh() {
        const cacheBuster = Date.now();
        const [planText] = await Promise.all([
          loadFile("PLAN.md", planEl, { cacheBuster }),
          loadFile("LOG.md", logEl, { lineLimit: 25, cacheBuster }),
          loadFile("RELEASES.md", releasesEl, { cacheBuster }),
        ]);
        const stepText = extractCurrentStep(planText);
        currentStepEl.innerHTML = escapeHtml(stepText).replace(/: /, ":<br>");
        const now = new Date();
        lastUpdatedEl.textContent = now.toLocaleTimeString();
      }

      refresh();
      setInterval(refresh, REFRESH_MS);
    </script>
  </body>
</html>
